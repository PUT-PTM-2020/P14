<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Weather Station</title>

  <style>
    a.tilelink {
      text-decoration: none;
      height: 80px;
      color: #ffffff;
    }

    a.tilelink:hover {
      text-decoration: none;
      height: 80px;
      color: #ffffff;
    }

    a.tilelink1 {
      text-decoration: none;
      height: 40px;
      color: #ffffff;
      font-family: Verdana;
    }

    a.tilelink1:hover {
      text-decoration: none;
      height: 40px;
      color: #ffffff;
    }

    .square {
      width: 70%;
      margin-left: auto;
      margin-right: auto;
      vertical-align: middle text-al
    }

    tr {
      text-align: center
    }

    .bg-secondary {
      background-color: darkgray;
    }
  </style>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body class="bg-secondary">

  <section id="top">
    <nav class="navbar navbar-dark bg-dark flex-column">
      <a href="./" class="tilelink">
        <font size="7">Weather Station</font>
      </a>
      <a class="tilelink1 text-white">
        <font size="4">Data</font>
      </a>
      <a href="about" class="tilelink1">
        <font size="4">About</font>
      </a>
    </nav>
  </section>

  <div class="my-5"></div>

  <section>
    <h4 id="error" class="text-white text-center m-0">Weather data available on the device</h4>
    <hr class="my-4">
    <div id="phase1">
      <p id="info" class="lead text-white text-center"></p>
      <div class="my-2"></div>
      <form>
        <div class="container-fluid col-md-4">
          <div id="amount" class="form-group text-center text-white" style="display: none;">
            <label for="offset_setter">Choose offset</label>
            <select class="form-control" id="offset_setter">
              <!-- options -->
            </select>
            <div class="my-3"></div>
            <button type="button" onclick="getData()" class="btn btn-light">Submit</button>
          </div>
        </div>
      </form>
    </div>
  </section>

  <div class="my-5"></div>

  <div class="square">
    <table id="table" cellspacing="0" border="1" style="width: 100%;display: none;">
      <tbody id="fetched_data">
        <tr bgcolor="#3095d3">
          <th width="17%" align="center">Record ID</th>
          <th width="16%" align="center">Inner Sensor?</th>
          <th width="16%" align="center">Temperature [C]</th>
          <th width="16%" align="center">Humidity [%]</th>
          <th width="16%" align="center">Date</th>
          <th width="16%" align="center">Time</th>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="my-5"></div>

  <div class="d-flex justify-content-center">
    <div id="spinner" class="spinner-grow" role="status">
      <span class="sr-only">Loading data...</span>
    </div>
  </div>

  <div class="my-5"></div>

  <footer class="bg-black small text-center text-white-50">
    <div class="container">
      2020 &copy COPYRIGHT BY POZNAN UNIVERSITY OF TECHNOLOGY | All rights reserved
    </div>
  </footer>

  <div class="my-2"></div>

</body>

<script type="text/javascript">

  var parent = document.getElementById('fetched_data');
  var url = window.location.href;
  const N = 20;

  var url = 'http://192.168.0.106/'

  setTimeout(() => {
    fetch(url + 'all')
      .then(res => res.json())
      .then(obj => {
        if (obj.amount > N) {
          document.getElementById('info').innerHTML = 'The device has <b>' + obj.amount + '</b> logs, but only ' + N + ' can be fetched at a time.<br>Please specify the offset (0 means latest ' + N + ' logs).';
          document.getElementById('amount').style.display = 'block';

          var parent = document.getElementById('offset_setter');
          for (var i = 0; i < obj.amount / N; i++) {
            var elem = document.createElement('option');
            elem.innerText = i * N;
            parent.appendChild(elem);
          }
        }
      })
      .catch(e => console.log(e));

    setTimeout(() => {
      document.getElementById('spinner').style.display = 'none';
    }, 1400);

  }, 2000);

  function getData() {
    document.getElementById('spinner').style.display = 'block';
    document.getElementById('phase1').style.display = 'none';

    var choice = document.getElementById('offset_setter');
    var offset = parseInt(choice.options[choice.selectedIndex].text);

    for (var i = 0; i < 1; i++) {
      console.log(i);

      setTimeout(() => {
        fetch(url + 'all/elem', {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain'
          },
          body: '{"offset":' + offset + ',"index":' + i + '}'
        })
          .then(res => res.json())
          .then(obj => {
            var row = document.createElement('tr');
            parent.appendChild(row);

            Object.keys(obj).forEach(key => {
              var data = document.createElement('td');
              data.setAttribute('align', 'center');
              data.setAttribute('class', 'text-white ')
              data.textContent = obj[key];
              row.appendChild(data);
            });

          }).catch(e => {
            document.getElementById('error').innerHTML = 'Device is <i>busy</i> right now.<br>Please try again in a minute.'
          });

        setTimeout(() => {
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('table').style.display = 'block';
        }, 1200);

      }, i * 1000);
    }
  }
</script>

</html>